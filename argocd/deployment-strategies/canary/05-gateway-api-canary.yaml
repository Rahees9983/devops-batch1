# Gateway API approach with weight-based traffic splitting

---
apiVersion: v1
kind: Service
metadata:
  name: myapp-v1-service
  namespace: default
spec:
  selector:
    app: myapp
    version: v1
  ports:
  - port: 80
    targetPort: 8080

---
apiVersion: v1
kind: Service
metadata:
  name: myapp-v2-service
  namespace: default
spec:
  selector:
    app: myapp
    version: v2
  ports:
  - port: 80
    targetPort: 8080

---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: myapp-canary-route
  namespace: default
spec:
  parentRefs:
    - name: saudicloud-gateway
  hostnames:
    - canary.saudicloud.com
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        # 90% traffic to v1 (stable)
        - name: myapp-v1-service
          port: 80
          weight: 90
        # 10% traffic to v2 (canary)
        - name: myapp-v2-service
          port: 80
          weight: 10

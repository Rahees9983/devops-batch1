# Nginx Configuration - Generated by Ansible
# Template: nginx.conf.j2
# Do not edit manually - changes will be overwritten

user {{ nginx_user | default('nginx') }};
worker_processes {{ nginx_worker_processes | default('auto') }};
error_log /var/log/nginx/error.log {{ nginx_error_log_level | default('warn') }};
pid /run/nginx.pid;

events {
    worker_connections {{ nginx_worker_connections | default(1024) }};
    use epoll;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Logging
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    log_format json escape=json '{'
        '"time": "$time_iso8601",'
        '"remote_addr": "$remote_addr",'
        '"method": "$request_method",'
        '"uri": "$request_uri",'
        '"status": $status,'
        '"body_bytes_sent": $body_bytes_sent,'
        '"request_time": $request_time,'
        '"http_referrer": "$http_referer",'
        '"http_user_agent": "$http_user_agent"'
    '}';

    access_log /var/log/nginx/access.log {{ nginx_log_format | default('main') }};

    # Performance
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout {{ nginx_keepalive_timeout | default(65) }};
    types_hash_max_size 2048;

    # Security Headers
{% if nginx_security_headers | default(true) %}
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
{% endif %}

    # Gzip Compression
{% if nginx_gzip_enabled | default(true) %}
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript
               application/xml application/rss+xml application/atom+xml image/svg+xml;
{% endif %}

    # Rate Limiting
{% if nginx_rate_limiting | default(false) %}
    limit_req_zone $binary_remote_addr zone=api:10m rate={{ nginx_rate_limit | default('10r/s') }};
    limit_conn_zone $binary_remote_addr zone=conn:10m;
{% endif %}

    # SSL Configuration
{% if nginx_ssl_enabled | default(false) %}
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_session_tickets off;
{% endif %}

    # Upstream Servers
{% if upstream_servers is defined and upstream_servers | length > 0 %}
    upstream {{ app_name | default('app') }}_backend {
{% if upstream_method | default('round_robin') == 'least_conn' %}
        least_conn;
{% elif upstream_method == 'ip_hash' %}
        ip_hash;
{% endif %}
{% for server in upstream_servers %}
        server {{ server.host }}:{{ server.port | default(8080) }} weight={{ server.weight | default(1) }}{% if server.backup | default(false) %} backup{% endif %};
{% endfor %}

        keepalive {{ upstream_keepalive | default(32) }};
    }
{% endif %}

    # Virtual Hosts
{% for vhost in virtual_hosts | default([]) %}
    server {
        listen {{ vhost.port | default(80) }}{% if vhost.default_server | default(false) %} default_server{% endif %};
{% if vhost.ssl | default(false) %}
        listen {{ vhost.ssl_port | default(443) }} ssl{% if vhost.http2 | default(true) %} http2{% endif %};
        ssl_certificate {{ vhost.ssl_certificate }};
        ssl_certificate_key {{ vhost.ssl_certificate_key }};
{% endif %}
        server_name {{ vhost.server_name }}{% if vhost.server_aliases is defined %} {{ vhost.server_aliases | join(' ') }}{% endif %};

        root {{ vhost.root | default('/var/www/html') }};
        index {{ vhost.index | default('index.html index.php') }};

{% if vhost.access_log is defined %}
        access_log {{ vhost.access_log }};
{% endif %}
{% if vhost.error_log is defined %}
        error_log {{ vhost.error_log }};
{% endif %}

{% if vhost.client_max_body_size is defined %}
        client_max_body_size {{ vhost.client_max_body_size }};
{% endif %}

{% for location in vhost.locations | default([]) %}
        location {{ location.path }} {
{% if location.proxy_pass is defined %}
            proxy_pass {{ location.proxy_pass }};
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
{% if location.websocket | default(false) %}
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
{% endif %}
{% elif location.root is defined %}
            root {{ location.root }};
{% elif location.alias is defined %}
            alias {{ location.alias }};
{% endif %}
{% if location.try_files is defined %}
            try_files {{ location.try_files }};
{% endif %}
{% if location.fastcgi_pass is defined %}
            fastcgi_pass {{ location.fastcgi_pass }};
            fastcgi_index index.php;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
{% endif %}
{% if location.custom_config is defined %}
            {{ location.custom_config | indent(12) }}
{% endif %}
        }

{% endfor %}
{% if vhost.custom_config is defined %}
        {{ vhost.custom_config | indent(8) }}
{% endif %}
    }

{% endfor %}
    # Include additional configuration files
    include /etc/nginx/conf.d/*.conf;
}
